<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta property="wb:webmaster" content="503aaa4467ff19a9" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
  <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>Openshare by 100apps</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>OpenShare</h1>
        <h2>利用社交软件移动客户端分享(不用官方SDK)</h2>
        <a href="https://github.com/100apps/openshare" class="button"><small>View project on</small> GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h3>
            <a id="welcome-to-openshare" class="anchor" href="#welcome-to-openshare" aria-hidden="true"><span class="octicon octicon-link"></span></a>Welcome to OpenShare.</h3>
            <p> <span style="color:red">注:</span> 为方便书写，如无特殊说明，下文中的「<strong>客户端</strong>」指的是QQ、微信、微博这样的社交软件官方开发的客户端；「<strong>app</strong>」特指我们自己开发的应用。</p>

            <p>楼主做iOS开发的过程中遇到这样的问题：自己app中的信息需要分享到QQ、微信、微博等社交网络。现在的客户端越做越强大，直接集成了分享功能，比如用户手机上安装了微信，只需要app调起微信，并且给微信传入相应的参数就可以了，完全不需要自己操作REST API。这样如果实现分享， 一般情况下要去官方下载SDK，然后按照官方翔一样的Demo代码和文档来改造自己的程序。这样做不仅增大了代码量(想象一下引入的官方类库，有时候，光这些第三方的SDK都要比我自己的app还大)，而且使用还很繁琐(SDK一般没有源代码，想象Apple强制app支持64位的时候)。所以楼主<i>调试</i>了一下各个平台的SDK，研究了各个厂商实现的应用程序间通信的规则，把功能封装成了OpenShare。</p>

            <p>OpenShare的功能就是替代官方的SDK向各个平台的移动客户端(比如QQ)发起请求(分享、OAuth)，然后接收返回结果。</p>
            <p>OpenShare非常小，目前支持QQ、微信、微博、人人，只有几百行代码。即使你不在项目中使用OpenShare，也可以clone下来研究一下app和客户端之间的通信机制，所以给个star是值得的。</p>

            <h3><a id="design" class="anchor" href="#design" aria-hidden="true"><span class="octicon octicon-link"></span></a>设计思路</h3>

            <p>比如分享功能，OpenShare有一个 <code>OSMessage</code>类，保存OpenShare向客户端发送的消息。分享的消息基本上有以下几种情况：</p>
            <ol>
              <li>纯文本</li>
              <li>图片</li>
              <li>链接</li>
              <li>其他格式多媒体(声音、视频、文件等)</li>
            </ol>

            <p>这样对应OSMessage中的属性：</p>
            <pre><code>@property NSString* title;
@property NSString* desc;
@property NSString* link;
@property NSData* image;
@property NSData* thumbnail;
@property OSMultimediaType multimediaType;
//for 微信
@property NSString* extInfo;
@property NSString* mediaDataUrl;
@property NSString* fileExt;
            </code></pre>
            <p>比如一个文本消息，可以只设置<code>title</code>，其他不管；发送一个图片，只需要设置image/thumbnail/title/desc，其他不用设置。对于其他多媒体消息，可以用<code>multimediaType</code>来标示。所以<code>OSMessage</code>可以封装所有app向客户端发的各类分享请求。</p>

            <p>另外，还需要解决的是，客户端分先完成以后回调app的功能。我们熟悉的是block方法。而不是每个平台都到<code>application:openURL:sourceApplication:annotation:</code>中判断。比如最好是这样的：</p>

            <pre><code>OSMessage *msg=[[OSMessage alloc] init];
msg.title=@"Hello World";
//分享到微信
[OpenShare shareToWeixinSession:msg Success:^(OSMessage *message) {
ULog(@"微信分享到会话成功：\n%@",message);
} Fail:^(OSMessage *message, NSError *error) {
ULog(@"微信分享到会话失败：\n%@\n%@",error,message);
}];
//分享到QQ
[OpenShare shareToQQFriends:msg Success:^(OSMessage *message) {
ULog(@"分享到QQ好友成功:%@",msg);
} Fail:^(OSMessage *message, NSError *error) {
ULog(@"分享到QQ好友失败:%@\n%@",msg,error);
}];
    </code></pre>
    <p>基于以上考虑，楼主用category实现了OpenShare。</p>

    <h3>
      <a id="how-to-use" class="anchor" href="#how-to-use" aria-hidden="true"><span class="octicon octicon-link"></span></a>如何使用</h3>

      <p><strong>第一步：</strong>到<code>AppDelegate</code>中的<code>application:didFinishLaunchingWithOptions:</code>中全局注册appId/appKey</p>
      <pre><code>//全局注册appId，别忘了#import "OpenShareHeader.h"
[OpenShare connectQQWithAppId:@"1103194207"];
[OpenShare connectWeiboWithAppKey:@"402180334"];
[OpenShare connectWeixinWithAppId:@"wxd930ea5d5a258f4f"];
[OpenShare connecRenrenWithAppId:@"228525" AndAppKey:@"1dd8cba4215d4d4ab96a49d3058c1d7f"];
      </code></pre>

      <p><strong>第二步：</strong>到<code>AppDelegate</code>中的<code>application:openURL:sourceApplication:annotation:</code>中添加整体回调：</p>
      <pre><code>//如果OpenShare能处理这个回调，就调用block中的方法，如果不能处理，就交给其他（比如支付宝）。
        if ([OpenShare handleOpenURL:url]) {
        return YES;
      }
    </code></pre>

    <p><strong>第三步：</strong>在需要分享、OAuth的地方调用：</p>
    <pre><code>//比如微信登录，其他登录可以参考文档或者代码，或者让Xcode自动提示。
[OpenShare WeixinAuth:@"snsapi_userinfo" Success:^(NSDictionary *message) {
ULog(@"微信登录成功:\n%@",message);
} Fail:^(NSDictionary *message, NSError *error) {
ULog(@"微信登录失败:\n%@\n%@",message,error);
}];
//分享纯文本消息到微信朋友圈，其他类型可以参考示例代码
OSMessage *msg=[[OSMessage alloc]init];
msg.title=@"Hello msg.title";
[OpenShare shareToWeixinTimeline:msg Success:^(OSMessage *message) {
ULog(@"微信分享到朋友圈成功：\n%@",message);
} Fail:^(OSMessage *message, NSError *error) {
ULog(@"微信分享到朋友圈失败：\n%@\n%@",error,message);
}];
</code></pre>

<h3>
  <a id="plugins" class="anchor" href="#plugins" aria-hidden="true"><span class="octicon octicon-link"></span></a>扩展支持更多平台</h3>
  <p>现在的社交网络各种各样，如何把这些平台集成到OpenShare中呢？其实非常简单。比如要支持人人，在下面的输入框中输入renren，即可生成<code>OpenShare+Renren.h</code>和<code>OpenShare+Renren.m</code>的模板。通过这个模板做相应的修改即可。做好以后如果想全局使用，别忘了在<code>OpenShareHeader.h</code>中引用。</p>
  <input type="text" id="pluginName" value="Renren">
  <pre><code id="pluginName.h"></code></pre>
  <pre><code id="pluginName.m"></code></pre>
  <h3>
    <a id="authors-and-contributors" class="anchor" href="#authors-and-contributors" aria-hidden="true"><span class="octicon octicon-link"></span></a>Authors and Contributors</h3>

    <p>由于每个厂商的通信协议都不一样，所以hack的时候还是走了一些弯路，如果想了解整个实现过程，可以看看我的博客：<a href="http://www.gfzj.us/series/openshare/">http://www.gfzj.us/series/openshare/</a></p>
<p>现在行业急需要像OAuth一样的标准，来实现app和客户端之间的分享，登录。这样就不用为每一个客户端实现一遍了。比如这个协议标准就叫做「OpenShare」（大言不惭、捂脸中）。客户端只需要声明支持OpenShare的某个版本，app就能很简单的调用了。如果您对实现OpenShare标准有任何想法，欢迎交流。</p>
    <h3>
      <a id="support-or-contact" class="anchor" href="#support-or-contact" aria-hidden="true"><span class="octicon octicon-link"></span></a>Support or Contact</h3>

<p>在OpenShare使用过程中有任何问题，都可以<a href="https://github.com/100apps/openshare/issues">添加一个issues</a>，我会及时解决。如果您想贡献代码，欢迎<a href="https://github.com/100apps/openshare/pulls">Pull Requests</a>。其他任何问题可以在下面留言，或者通过邮箱<a href="mailto:gf@gfzj.us">gf@gfzj.us</a>联系我。</p>


<script type="text/javascript">
(function(){
var url = "http://widget.weibo.com/distribution/comments.php?width=0&url=auto&border=1&brandline=y&appkey=3767475828&dpc=1";
url = url.replace("url=auto", "url=" + encodeURIComponent(document.URL)); 
document.write('<iframe id="WBCommentFrame" src="' + url + '" scrolling="no" frameborder="0" style="width:100%"></iframe>');
})();
</script>
<script src="http://tjs.sjs.sinajs.cn/open/widget/js/widget/comment.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
window.WBComment.init({
    "id": "WBCommentFrame"
});
</script>

    </section>

    <aside id="sidebar">
      <a href="https://github.com/100apps/openshare/zipball/master" class="button">
        <small>Download</small>
        .zip file
      </a>
      <a href="https://github.com/100apps/openshare/tarball/master" class="button">
        <small>Download</small>
        .tar.gz file
      </a>

      <p class="repo-owner"><a href="https://github.com/100apps/openshare"></a> is maintained by <a href="https://github.com/100apps">100apps</a>.</p>

      <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the Architect theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>
    </aside>
  </div>
</div>



<script>
function $(id){return document.getElementById(id)}
function genPlugin(){
  var n=$("pluginName").value;
  var name=n.charAt(0).toUpperCase()+(n.substr(1).toLowerCase());
  if(n!=name)$("pluginName").value=name;

  var h='//OpenShare+Renren.h 文件内容\n#import "OpenShare.h"\n@interface OpenShare (Renren)\n+(void)connecRenrenWithAppId:(NSString *)appId AndAppKey:(NSString*)appKey;\n+(BOOL)isRenrenInstalled;+(void)shareToRenrenSession:(OSMessage*)msg Success:(shareSuccess)success Fail:(shareFail)fail;+(void)shareToRenrenTimeline:(OSMessage*)msg Success:(shareSuccess)success Fail:(shareFail)fail;\n\n@end';
  var m='//OpenShare+Renren.m 文件内容\n#import "OpenShare+Renren.h"\n\n@implementation OpenShare (Renren)\nstatic NSString* schema=@"Renren";\n//示例代码，注册全局信息\n+(void)connecRenrenWithAppId:(NSString *)appId AndAppKey:(NSString*)appKey{\n    [self set:schema Keys:@{@"appid":appId,@"appkey":appKey}];\n}\n//示例代码，判断是否安装，注意客户端的schema需要修改\n+(BOOL)isRenrenInstalled{\n    return [self canOpen:@"renrenshare://share"];\n}\n//示例代码：聊天，私信\n+(void)shareToRenrenSession:(OSMessage*)msg Success:(shareSuccess)success Fail:(shareFail)fail{\n    if ([self beginShare:schema Message:msg Success:success Fail:fail]) {\n        [self openURL:[self genRenrenShareUrl:msg to:0]];\n    }\n}\n//示例代码：朋友圈，新鲜事等\n+(void)shareToRenrenTimeline:(OSMessage*)msg Success:(shareSuccess)success Fail:(shareFail)fail{\n    if ([self beginShare:schema Message:msg Success:success Fail:fail]) {\n        [self openURL:[self genRenrenShareUrl:msg to:1]];\n    }\n}\n//示例代码，生成分享链接。\n+(NSString*)genRenrenShareUrl:(OSMessage*)msg to:(int)shareTo{\n   return @"";   \n }\n//示例代码，分享，登录成功以后，回调。如果能处理(不管返回结果)就返回YES，否则返回NO，让别人处理。必须实现\n+(BOOL)Renren_handleOpenURL{\n    NSURL* url=[self returnedURL];\n    if ([url.scheme hasPrefix:@"renrenshare"]) {\n        if ([self shareSuccesCallback]) {\n            [self shareSuccesCallback]([self message]);\n        }\n        return YES;\n    }else{\n        return NO;\n    }\n}\n\n@end';
  $("pluginName.h").innerHTML=h.replace(/Renren/g,name);
  $("pluginName.m").innerHTML=m.replace(/Renren/g,name);
}
$("pluginName").onkeyup=genPlugin;
genPlugin();
</script>
</body>
</html>
